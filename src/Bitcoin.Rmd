---
title: "Time Series Analysis final Project - Competitive "
author: "Team Members: 1.Rahul k. gupta (s3635232) 2.Terrie christensen (s3664899) 3.Napapach Dechawatthanaphokin (s3613572)"
date: "14 May 2018"
output:
  pdf_document:
    fig_caption: yes
    number_sections: yes
    toc: no
    toc_depth: 3
subtitle: MATH 1318 Time Series Analysis Final Project
documentclass: article
---


```{r global_options, include=FALSE, warning=FALSE}
require(knitr)
opts_chunk$set(warning=FALSE, message=FALSE)
```


\newpage

\tableofcontents

\newpage

# Introduction \label{sec1}

Bitcoin or BTC is a digital currency, otherwise known as a cryptocurrency. it was introduced to markets in 2009 by 'Satoshi Nakamoto.' The most notable aspect of BTC is that no banks or financial institutions are needed to facilitate trades. Additionally, it runs as a virtually anonymous financial system whereby buyers and sellers do not need to input their names, addresses or any other personally identifiable information to transfer BTC.

Rahul Made these changes

# Initial Diagnosis

```{r}
# Import Libraries
library(TSA)
library(fUnitRoots)
library(forecast)
library(CombMSC)
library(lmtest)
library(fGarch)
library(rugarch)
library(zoo)
library(ggplot2)
require(readr)
require(FitAR)

Bitcoin <- read.csv("../data/Bitcoin_Historical_Price.csv", header=TRUE)
Bitcoin$Date = as.Date(Bitcoin$Date,'%Y-%m-%d')
```



```{r}
Bitcoin.zoo <- zoo(Bitcoin$Close, Bitcoin$Date)
class(Bitcoin.zoo)
Bitcoin.raw = Bitcoin.zoo
```


```{r}
autoplot.zoo(Bitcoin.zoo) +
  ylab('Closing Price (USD)') + 
  xlab('Time (days)') +
  ggtitle("Time Series Plot for Daily Bitcoin Prices")
```


```{r}

Bitcoin.2017 = Bitcoin[Bitcoin$Date > as.Date("2017-04-01"),]
Bitcoin.2017.zoo = zoo(Bitcoin.2017$Close, Bitcoin.2017$Date)
autoplot(Bitcoin.2017.zoo) +
  geom_point(size=.5) +
  ylab('Closing Price (USD)') + 
  xlab('Time (days)') +
  ggtitle("Time Series Plot for Daily Bitcoin Prices (2017-2018)")
```

## Scatter Plot and correlation

```{r}
ggplot(Bitcoin.2017,aes(zlag(Close), Close)) + geom_point() +
  ylab('Current Closing Price (USD)') + 
  xlab('Previous Day Closing Price (USD)') +
  ggtitle("Scatter Plot of Bitcoin Daily Closing Prices")
```


```{r}
y = as.vector(Bitcoin.2017.zoo)
x = zlag(Bitcoin.2017.zoo)     
index = 2:length(x)      
cor(y[index],x[index])
```

## Linear Model

```{r}
model.ln = lm(Bitcoin.2017.zoo~time(Bitcoin.2017.zoo)) # label the linear trend model as model.ln
summary(model.ln)
```

```{r}
ggplot(Bitcoin.2017,aes(Date,Close))+ 
  geom_line()  +
  ylab('Closing Price (USD)') + 
  xlab('') +
  ggtitle('Linear Fitted Model - Bitcoin Prices') +
  geom_line(aes(y=fitted(model.ln)),color='#fc5e13')
```


## Residual Analysis - Linear Model

Below are the findings of residuals from linear model

\vspace{12pt}

```{r fig.cap=paste("\\label{fig:res_lin}Residual Analysis Linear fitted Model")}
residual_analysis_qq <- function(myresiduals, title = 'QQ Plot of Residuals') {
data=as.data.frame(qqnorm( myresiduals , plot=F))
ggplot(data,aes(x,y)) + 
  geom_point() + 
  geom_smooth(method="lm", se=FALSE, color='#e36209', size=.4)+
  xlab('Theoretical') +
  ylab('Sample') +
  ggtitle(title)
}

checkresiduals(model.ln)
```


\vspace{12pt}

```{r fig.cap=paste("\\label{fig:res_lin_qq}Residual Analysis Linear fitted Model")}
residual_analysis_qq(residuals(model.ln))
```

\vspace{12pt}

```{r}
shapiro.test(as.vector(residuals(model.ln)))
```

## Quadratic Model

```{r}
t = as.vector(time(Bitcoin.2017.zoo))
t2 = t^2
model.qa = lm(Bitcoin.2017.zoo~ t + t2) # label the quadratic trend model as model.qa
summary(model.qa)

ggplot(Bitcoin.2017,aes(Date,Close))+ 
  geom_line()  +
  ylab('Closing Price (USD)') + 
  xlab('') +
  ggtitle('Quadratic fitted Model Curve - Bitcoin Daily Prices') +
  geom_line(aes(y=fitted(model.qa)),color='#fc5e13')
```


## Residual Analysis - Linear Model

Below are the findings of residuals from linear model

\vspace{12pt}

```{r fig.cap=paste("\\label{fig:res_lin}Residual Analysis Quadratic fitted Model")}
checkresiduals(model.qa)
```


\vspace{12pt}

```{r fig.cap=paste("\\label{fig:res_lin_qq}Residual Analysis Linear fitted Model")}
residual_analysis_qq(residuals(model.qa))
```

\vspace{12pt}

```{r}
shapiro.test(as.vector(residuals(model.qa)))
```

# Models for Nonstationary Time Series

Auto regressive behaviour and non staionay
Staionay is the first thing we need to check.

```{r}
ggtsdisplay(Bitcoin.2017.zoo,
            main = 'ACF and PACF of Bitcoin Prices', 
            ylab='Closing Price (USD)')
```


stategy to make stationay is transfromation.

```{r}
Bitcoin.transform = BoxCox.ar(Bitcoin.2017.zoo, method = 'yule-walker') 
```

```{r}
lambda = sum(Bitcoin.transform$ci)/length(Bitcoin.transform$ci)
Bitcoin.boxcox = (Bitcoin.2017.zoo^lambda - 1) / lambda 
Bitcoin.diff = base::diff(Bitcoin.boxcox, differences = 1)
autoplot(Bitcoin.diff) +
  ylab('Closing Price (USD)') + 
  ggtitle('Boxcox Transformed & First Differenced Series')
```

```{r}
ggtsdisplay(Bitcoin.diff, lag.max = 96,ci.type='ma',
            main = 'Boxcox Transformed & First Differenced ACF and PACF plots', 
            ylab='')
```

```{r}
adf.test(Bitcoin.diff)
```


```{r}
eacf(Bitcoin.diff)
# ARIMA(0,1,0),ARIMA(1,1,1),ARIMA(2,1,2),ARIMA(4,1,3)
```

```{r}
res1 = armasubsets(y=Bitcoin.diff,nar=14,nma=14,y.name='test',ar.method='mle')
plot(res1)
#ARIMA(4,1,4),ARIMA(5,1,4)
```



```{r}
#The final set of possible models is 
# ARIMA(0,1,0),ARIMA(1,1,1),ARIMA(2,1,2),ARIMA(4,1,3)
# ARIMA(4,1,4),ARIMA(5,1,4)

# ARIMA(0,1,0)
model_111_css = arima(Bitcoin.boxcox, order=c(1,1,1),method='CSS')
coeftest(model_111_css)

model_111_ml = arima(Bitcoin.boxcox, order=c(1,1,1),method='ML')
coeftest(model_111_ml)

```

```{r}
# ARIMA(2,1,2)
model_212_css = arima(Bitcoin.boxcox,order=c(2,1,2),method='CSS')
coeftest(model_212_css)

model_212_ml = arima(Bitcoin.boxcox,order=c(2,1,2),method='ML')
coeftest(model_212_ml)
```

```{r}
# ARIMA(2,1,2)
model_313_css = arima(Bitcoin.boxcox,order=c(3,1,3),method='CSS')
coeftest(model_313_css)

model_313_ml = arima(Bitcoin.boxcox,order=c(3,1,3),method='ML')
coeftest(model_313_ml)
```


```{r}
# ARIMA(4,1,3)
model_413_css = arima(Bitcoin.boxcox,order=c(4,1,3),method='CSS')
coeftest(model_413_css)

model_413_ml = arima(Bitcoin.boxcox,order=c(4,1,3),method='ML')
coeftest(model_413_ml)
```

```{r}

# ARIMA(4,1,4)
model_414_css = arima(Bitcoin.boxcox,order=c(4,1,4),method='CSS')
coeftest(model_414_css)

model_414_ml = arima(Bitcoin.boxcox,order=c(4,1,4),method='ML')
coeftest(model_414_ml)
```

```{r}
# ARIMA(5,1,4)
model_514_css = arima(Bitcoin.boxcox,order=c(5,1,4),method='CSS')
coeftest(model_514_css)

model_514_ml = arima(Bitcoin.boxcox,order=c(5,1,4),method='ML')
coeftest(model_514_ml)

```


```{r}
source('sort.score.r')
sort.score(stats::AIC(model_111_ml,model_212_ml,model_313_ml,model_413_ml,model_414_ml,model_514_ml), score = "aic")
sort.score(stats::BIC(model_111_ml,model_212_ml,model_313_ml,model_413_ml,model_414_ml,model_514_ml), score = "bic" )
```


\vspace{12pt}

```{r}
fit <- Arima(Bitcoin.2017.zoo, order=c(2,1,2), lambda = lambda)
summary(fit)
```

## Residual Analysis - ARIMA Model

Below are the findings of residuals from linear model

\vspace{12pt}

```{r fig.cap=paste("\\label{fig:res_lin}Residual Analysis Quadratic fitted Model")}
checkresiduals(fit)
```


\vspace{12pt}

```{r fig.cap=paste("\\label{fig:res_lin_qq}Residual Analysis Linear fitted Model")}
residual_analysis_qq(residuals(fit))
```

\vspace{12pt}

```{r}
shapiro.test(as.vector(residuals(fit)))
```

\vspace{12pt}

```{r}
x = residuals(fit)
k=0
LBQPlot(x, lag.max = length(x)-1 , StartLag = k + 1, k = 0, SquaredQ = FALSE)
grid()
```


## Forecast 

```{r}
autoplot(forecast(fit,h=10))
```

```{r}
Bitcoin.forecast <- read_csv("../data/Bitcoin_Prices_Forecasts.csv")
Bitcoin.forecast$Date = as.Date(Bitcoin.forecast$Date,'%d/%m/%y')
```

## MASE Error

```{r}
source('MASE.r')
MASE(Bitcoin.forecast$Closing.price, as.vector(tail(fitted(forecast(fit,h=10)),10)))
```



```{r}
McLeod.Li.test(y=Bitcoin.2017.zoo,main="McLeod-Li Test Statistics for Bitcoin")

residual_analysis_qq(Bitcoin.2017.zoo, 'QQ Plot')
```

